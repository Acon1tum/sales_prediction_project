<!-- backend/templates/forecast_details.html -->
{% extends "base.html" %}

{% block title %}Forecastrix | Forecast Details{% endblock %}
{% block header_subtitle %}Detailed view of your forecast{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forecast_details.css') }}">
{% endblock %}

{% block content %}
<section class="forecast-details-container">
    <div class="forecast-details-header">
        <h1>Forecast Details</h1>
        <button onclick="window.history.back()" class="back-btn">
            <span>‚¨ÖÔ∏è</span> Back to History
        </button>
    </div>
    
    <div class="forecast-meta">
        <div class="meta-item">
            <span class="meta-label">Forecast Type:</span>
            <span class="meta-value">{{ forecast.forecast_type | capitalize }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Product:</span>
            <span class="meta-value">{{ forecast.product if forecast.product != "all" else "All Products" }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Created:</span>
            <span class="meta-value">{{ forecast.created_at | datetimeformat }}</span>
        </div>
        {% if upload_data %}
        <div class="meta-item">
            <span class="meta-label">Source File:</span>
            <span class="meta-value">{{ upload_data.file_name }}</span>
        </div>
        {% endif %}
    </div>
    
    <div class="forecast-summary">
        <div class="summary-card">
            <h3>Forecast Overview</h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ forecast.forecast_data.predictions | length }}</div>
                    <div class="stat-label">Days Forecasted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ forecast.forecast_data.predictions | sum | round(2) }}</div>
                    <div class="stat-label">Total Sales</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ forecast.threshold | round(2) }}</div>
                    <div class="stat-label">Threshold</div>
                </div>
            </div>
        </div>
        
        <div class="summary-card">
            <h3>Data Quality</h3>
            <div class="quality-stats">
                <div class="quality-item">
                    <span class="quality-label">Date Range:</span>
                    <span class="quality-value">{{ forecast.forecast_data.data_quality.date_range_days }} days</span>
                </div>
                <div class="quality-item">
                    <span class="quality-label">Unique Days:</span>
                    <span class="quality-value">{{ forecast.forecast_data.data_quality.unique_days }}</span>
                </div>
                <div class="quality-item">
                    <span class="quality-label">Data Density:</span>
                    <span class="quality-value">{{ (forecast.forecast_data.data_quality.data_density * 100) | round(1) }}%</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="forecast-charts">
        <div class="chart-container">
            <h3>Sales Predictions</h3>
            <canvas id="predictionsChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3>Trend Analysis</h3>
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
    
    <div class="forecast-decisions">
        <h2>Decision Insights</h2>
        <div class="decisions-list">
            {% for decision in forecast.forecast_data.decisions %}
            <div class="decision-item {{ 'positive' if decision.trend == 'positive' else 'negative' if decision.trend == 'negative' else 'neutral' }}">
                <div class="decision-icon">{{ decision.icon }}</div>
                <div class="decision-text">{{ decision.text }}</div>
                <div class="decision-severity">{{ decision.severity | capitalize }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="forecast-actions">
        <button onclick="exportForecast()" class="primary">
            <span>üì§</span> Export Forecast
        </button>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Prepare data for charts
    const forecastData = {{ forecast.forecast_data | tojson | safe }};
    const predictions = forecastData.predictions || [];
    const days = Array.from({length: predictions.length}, (_, i) => i + 1);
    
    // Create predictions chart
    const predictionsCtx = document.getElementById('predictionsChart').getContext('2d');
    new Chart(predictionsCtx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: 'Predicted Sales',
                data: predictions,
                borderColor: '#6C5CE7',
                backgroundColor: 'rgba(108, 92, 231, 0.1)',
                tension: 0.3,
                fill: true
            }, {
                label: 'Threshold',
                data: Array(predictions.length).fill({{ forecast.threshold }}),
                borderColor: '#00B894',
                borderDash: [5, 5],
                backgroundColor: 'transparent'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Sales Predictions'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Sales Amount'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Day'
                    }
                }
            }
        }
    });
    
    // Create trends chart
    const decisions = forecastData.decisions || [];
    const trendCounts = {
        positive: decisions.filter(d => d.trend === 'positive').length,
        negative: decisions.filter(d => d.trend === 'negative').length,
        neutral: decisions.filter(d => d.trend === 'neutral').length
    };
    
    const trendsCtx = document.getElementById('trendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
                data: [trendCounts.positive, trendCounts.negative, trendCounts.neutral],
                backgroundColor: [
                    'rgba(0, 184, 148, 0.7)',
                    'rgba(214, 48, 49, 0.7)',
                    'rgba(178, 190, 195, 0.7)'
                ],
                borderColor: [
                    'rgba(0, 184, 148, 1)',
                    'rgba(214, 48, 49, 1)',
                    'rgba(178, 190, 195, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Trend Distribution'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});

function exportForecast() {
    const forecastData = {{ forecast | tojson | safe }};
    const dataStr = JSON.stringify(forecastData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `forecast-{{ forecast.id }}-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}
</script>
{% endblock %}